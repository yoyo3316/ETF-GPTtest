<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ETFæŒè‚¡åˆ†æå¹³å° Pro</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    :root { --primary:#667eea; --primary-2:#764ba2; --success:#27ae60; --danger:#e74c3c; --muted:#888; --card-border:#f0f0f0; --bg-grad-a:#f5f7fa; --bg-grad-b:#c3cfe2; }
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,sans-serif;background:linear-gradient(135deg,var(--bg-grad-a) 0%,var(--bg-grad-b) 100%);color:#333;min-height:100vh}
    .gradient-header{background:linear-gradient(135deg,var(--primary) 0%,var(--primary-2) 100%);color:#fff;padding:40px 20px;text-align:center;margin-bottom:30px;box-shadow:0 8px 24px rgba(102,126,234,.3)}
    .gradient-header h1{font-size:32px;font-weight:700;margin-bottom:12px}
    .gradient-header p{font-size:13px;opacity:.95;margin:5px 0}
    .container{max-width:1400px;margin:0 auto;padding:0 20px}
    .tabs-container{background:#fff;border-bottom:3px solid var(--primary);margin-bottom:25px;border-radius:8px 8px 0 0;box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .tabs{display:flex;flex-wrap:wrap;gap:6px;padding:6px}
    .tab-btn{padding:12px 16px;background:none;border:none;cursor:pointer;color:var(--muted);font-size:15px;border-bottom:3px solid transparent;transition:.3s;border-radius:8px}
    .tab-btn:hover{color:#546ded;background:#f6f7ff}
    .tab-btn.active{color:#fff;background:linear-gradient(135deg,var(--primary) 0%,var(--primary-2) 100%);border-bottom-color:#fff}
    .content-box{background:#fff;border-radius:8px;padding:25px;box-shadow:0 4px 16px rgba(0,0,0,.08)}
    .etf-tabs{display:flex;gap:12px;margin-bottom:16px;border-bottom:2px solid #eee;padding-bottom:12px;flex-wrap:wrap}
    .etf-tab{background:none;border:none;cursor:pointer;color:var(--muted);font-size:14px;padding:8px 12px;border-bottom:3px solid transparent;transition:.2s;font-weight:500;border-radius:6px}
    .etf-tab:hover{color:#546ded;background:#f6f7ff}
    .etf-tab.active{color:var(--primary);border-bottom-color:var(--primary);font-weight:600}
    .etf-price-box{background:linear-gradient(135deg,#667eea15 0%,#764ba215 100%);border-radius:12px;padding:20px;margin-bottom:18px;border-left:5px solid var(--primary)}
    .etf-price-code{font-size:18px;font-weight:700;color:var(--primary)}
    .etf-price-name{font-size:12px;color:#999;margin-top:3px}
    .etf-price-value{font-size:32px;font-weight:700;color:#222;margin-top:10px}
    .etf-price-change{font-size:14px;margin-top:8px;font-weight:600}
    .etf-price-change.negative{color:var(--danger)}
    .etf-price-change.positive{color:var(--success)}
    .summary-bar{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:18px}
    .summary-card{background:#fff;border:2px solid var(--card-border);border-left:5px solid var(--primary);border-radius:10px;padding:14px}
    .summary-card h4{font-size:12px;color:#777;margin-bottom:8px;text-transform:uppercase;letter-spacing:.5px}
    .summary-val{font-size:20px;font-weight:800}
    .summary-val.positive{color:var(--success)}
    .summary-val.negative{color:var(--danger)}
    .changes-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:20px}
    .change-card{background:#fff;border-radius:12px;padding:16px;cursor:pointer;transition:.3s;border:2px solid var(--card-border);box-shadow:0 2px 8px rgba(0,0,0,.06);position:relative;overflow:hidden}
    .change-card::before{content:'';position:absolute;top:0;left:0;height:4px;width:100%;background:linear-gradient(90deg,#546ded,var(--primary-2));transition:height .3s}
    .change-card:hover{box-shadow:0 12px 32px rgba(84,110,237,.2);transform:translateY(-8px);border-color:var(--primary)}
    .change-card:hover::before{height:6px}
    .change-card.new-add{border:2px solid var(--success);background:linear-gradient(135deg,rgba(39,174,96,.05) 0%,rgba(39,174,96,.02) 100%)}
    .change-card.new-add::before{background:linear-gradient(90deg,var(--success),#16a34a)}
    .change-card.delete{border:2px solid var(--danger);background:linear-gradient(135deg,rgba(231,76,60,.05) 0%,rgba(231,76,60,.02) 100%)}
    .change-card.delete::before{background:linear-gradient(90deg,var(--danger),#c0392b)}
    .change-card-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--card-border)}
    .change-code-name{flex:1}
    .change-code{font-size:20px;font-weight:700;color:#222}
    .change-name{font-size:13px;color:#999;margin-top:2px;font-weight:500}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:8px 16px;border-radius:20px;font-size:13px;font-weight:700}
    .badge.new{background:linear-gradient(135deg,var(--success),#16a34a);color:#fff}
    .badge.add{background:#d1ecf1;color:#0c5460}
    .badge.reduce{background:#f8d7da;color:#721c24}
    .badge.delete{background:linear-gradient(135deg,var(--danger),#c0392b);color:#fff}
    .change-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;margin-bottom:14px}
    .stat-item{background:#f9fbfc;padding:14px;border-radius:8px;border-left:3px solid var(--primary)}
    .stat-label{font-size:11px;color:#999;margin-bottom:5px;text-transform:uppercase;letter-spacing:.5px}
    .stat-value{font-size:16px;font-weight:700;color:#222}
    .stat-value.positive{color:var(--success)}
    .stat-value.negative{color:var(--danger)}
    .search-box{margin-bottom:20px}
    .search-box input{width:100%;padding:14px 16px;border:2px solid #ddd;border-radius:8px;font-size:14px;transition:.2s}
    .search-box input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(102,126,234,.1);outline:none}
    .stocks-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px}
    .stock-card{background:#fff;border-radius:12px;padding:18px;border:2px solid var(--card-border);cursor:pointer;transition:.3s;box-shadow:0 2px 8px rgba(0,0,0,.06)}
    .stock-card:hover{box-shadow:0 12px 32px rgba(84,110,237,.15);transform:translateY(-6px);border-color:var(--primary)}
    .stock-card-header{margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--card-border)}
    .stock-code{font-size:18px;font-weight:700;color:var(--primary)}
    .stock-name{font-size:14px;color:#333;margin-top:4px;font-weight:500}
    .stock-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;font-size:13px}
    .stock-stat{background:#f9fbfc;padding:12px;border-radius:6px;border-left:3px solid var(--primary)}
    .stock-stat-label{color:#999;margin-bottom:4px;font-size:11px}
    .stock-stat-value{font-size:15px;font-weight:700;color:#222}
    .hidden{display:none}
    .detail-page{display:none}
    .detail-page.active{display:block}
    .back-btn{background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff;border:none;padding:12px 24px;border-radius:8px;cursor:pointer;margin-bottom:20px;font-size:14px;font-weight:600;transition:.3s;box-shadow:0 4px 12px rgba(102,126,234,.3)}
    .back-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(102,126,234,.4)}
    .stock-header{background:linear-gradient(135deg,#667eea15 0%,#764ba215 100%);border-radius:12px;padding:25px;box-shadow:0 4px 16px rgba(0,0,0,.08);margin-bottom:25px;border-left:5px solid var(--primary)}
    .stock-title{font-size:24px;font-weight:700;margin-bottom:18px;color:#222}
    .stats-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:18px;margin-bottom:20px}
    .stat-box{background:#fff;padding:18px;border-radius:12px;text-align:center;border:2px solid var(--card-border);transition:.2s}
    .stat-box:hover{border-color:var(--primary);box-shadow:0 4px 12px rgba(102,126,234,.15)}
    .stat-box-value{font-size:24px;font-weight:700;color:var(--primary)}
    .stat-box-label{font-size:12px;color:#999;margin-top:6px;text-transform:uppercase;letter-spacing:.5px}
    .chart-container{background:#fff;border-radius:12px;padding:20px;margin-bottom:25px;box-shadow:0 2px 8px rgba(0,0,0,.06);border:2px solid var(--card-border)}
    .chart-container h3{font-size:16px;font-weight:700;margin-bottom:15px;color:#222}
    .history-table{background:#fff;border-radius:12px;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;box-shadow:0 2px 8px rgba(0,0,0,.06);border:2px solid var(--card-border)}
    table{width:100%;border-collapse:collapse;min-width:720px}
    th{background:linear-gradient(135deg,#667eea15 0%,#764ba215 100%);padding:14px;text-align:left;font-weight:700;font-size:12px;color:#333;border-bottom:2px solid #e0e0e0;text-transform:uppercase;letter-spacing:.5px;white-space:nowrap}
    td{padding:14px;border-bottom:1px solid var(--card-border);font-size:13px;white-space:nowrap}
    tbody tr{transition:.2s}
    tbody tr:hover{background:linear-gradient(90deg,#667eea05 0%,#764ba205 100%);box-shadow:inset 0 0 10px rgba(102,126,234,.1)}
    .row-highlight{background:linear-gradient(90deg,rgba(39,174,96,.1) 0%,rgba(39,174,96,.05) 100%)}
    .row-delete{background:linear-gradient(90deg,rgba(231,76,60,.1) 0%,rgba(231,76,60,.05) 100%)}
    .status-badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600}
    .status-new{background:#d4edda;color:#155724}
    .status-delete{background:#f8d7da;color:#721c24}
    .status-add{background:#d1ecf1;color:#0c5460}
    .status-reduce{background:#f8d7da;color:#721c24}
    .no-data{color:#999;text-align:center;padding:30px;font-size:14px}
    .loading-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.75);backdrop-filter:blur(2px);z-index:9999}
    .loading-overlay.active{display:flex}
    .spinner{width:44px;height:44px;border:4px solid #e5e7eb;border-top-color:var(--primary);border-radius:50%;animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @media(max-width:480px){.gradient-header h1{font-size:24px}.gradient-header p{font-size:12px}.content-box{padding:16px}.etf-tab{font-size:13px;padding:8px 10px}.stat-item{padding:10px}.stat-value{font-size:15px}.stock-title{font-size:20px}.back-btn{padding:10px 16px;font-size:13px}.badge{padding:6px 10px;font-size:12px}.changes-grid{grid-template-columns:1fr!important}.stocks-grid{grid-template-columns:1fr!important}#trendChart{max-height:240px}}
  </style>
</head>
<body>
  <div class="gradient-header">
    <h1>ğŸš€ ETFæŒè‚¡åˆ†æå¹³å° Pro</h1>
    <p id="updateTime" aria-live="polite">æœ€æ–°æ›´æ–°: --/--/--</p>
    <p>å¯¦æ™‚ç•°å‹•ç›£æ§ â€¢ æ™ºèƒ½æŒè‚¡åˆ†æ â€¢ å®Œæ•´æ­·å²è¿½è¹¤</p>
  </div>
  <div class="container">
    <div class="tabs-container">
      <div class="tabs">
        <button class="tab-btn active" data-mode="changes" aria-controls="changesMode">ğŸ“Š ç•°å‹•æ˜ç´°</button>
        <button class="tab-btn" data-mode="search" aria-controls="searchMode">ğŸ” è‚¡ç¥¨æŸ¥è©¢</button>
        <button class="tab-btn" data-mode="ranks" aria-controls="ranksMode">ğŸ† ç•°å‹•æ’è¡Œ</button>
        <button class="tab-btn" data-mode="strategy" aria-controls="strategyMode">ğŸ“ˆ è¶¨å‹¢è¨Šè™Ÿ</button>
      </div>
    </div>

    <div id="changesMode" class="content-box" role="region" aria-label="ç•°å‹•æ˜ç´°">
      <div class="etf-tabs" id="etfTabs">
        <button class="etf-tab active" data-etf="00981A">00981A çµ±ä¸€å°è‚¡å¢é•·</button>
        <button class="etf-tab" data-etf="00980A">00980A é‡æ‘æ™ºæ…§å„ªé¸</button>
        <button class="etf-tab" data-etf="00982A">00982A ç¾¤ç›Šå¼·æ£’</button>
      </div>
      <div id="etfPriceInfo"></div>
      <div id="summaryBar" class="summary-bar"></div>
      <div id="changesGrid" class="changes-grid"></div>
    </div>

    <div id="searchMode" class="content-box hidden" role="region" aria-label="è‚¡ç¥¨æŸ¥è©¢">
      <div class="search-box">
        <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹è‚¡ç¥¨ä»£ç¢¼æˆ–åç¨±... ä¾‹å¦‚: 2330ã€å°ç©é›»" aria-label="æœå°‹è‚¡ç¥¨">
      </div>
      <div class="stocks-grid" id="stocksList"></div>
    </div>

    <div id="ranksMode" class="content-box hidden" role="region" aria-label="ç•°å‹•æ’è¡Œ">
      <div class="etf-tabs" id="etfTabsRanks">
        <button class="etf-tab active" data-etf="00981A">00981A çµ±ä¸€å°è‚¡å¢é•·</button>
        <button class="etf-tab" data-etf="00980A">00980A é‡æ‘æ™ºæ…§å„ªé¸</button>
        <button class="etf-tab" data-etf="00982A">00982A ç¾¤ç›Šå¼·æ£’</button>
      </div>
      <div id="ranksGrids"></div>
    </div>

    <div id="strategyMode" class="content-box hidden" role="region" aria-label="è¶¨å‹¢è¨Šè™Ÿ">
      <div class="etf-tabs" id="etfTabsStrategy">
        <button class="etf-tab active" data-etf="00981A">00981A çµ±ä¸€å°è‚¡å¢é•·</button>
        <button class="etf-tab" data-etf="00980A">00980A é‡æ‘æ™ºæ…§å„ªé¸</button>
        <button class="etf-tab" data-etf="00982A">00982A ç¾¤ç›Šå¼·æ£’</button>
      </div>
      <div id="strategyHeader" class="etf-price-box" style="margin-bottom:16px;"></div>
      <div id="strategyGrids"></div>
    </div>

    <div id="detailPage" class="detail-page" role="region" aria-label="è‚¡ç¥¨è©³ç´°">
      <button class="back-btn" id="backBtn">â† è¿”å›</button>
      <div class="stock-header">
        <div class="stock-title" id="detailTitle"></div>
        <div class="stats-row" id="statsContainer"></div>
      </div>
      <div class="etf-tabs" id="etfTabsDetail" style="margin-bottom:25px;"></div>
      <div class="chart-container" id="chartContainer" style="display:none;">
        <h3>ğŸ“ˆ æŒè‚¡è¶¨å‹¢åœ–</h3>
        <canvas id="trendChart" style="width:100%;height:auto;max-height:300px;"></canvas>
      </div>
      <div class="history-table">
        <table id="historyTable">
          <thead>
            <tr>
              <th>ğŸ“… æ—¥æœŸ</th>
              <th>ğŸ“Š æŒè‚¡(å¼µ)</th>
              <th>ğŸ’¯ æ¬Šé‡(%)</th>
              <th>ğŸ“ˆ å¼µæ•¸è®Šå‹•</th>
              <th>ğŸ“Š æ¬Šé‡è®Šå‹•</th>
              <th>ğŸ·ï¸ ç‹€æ…‹</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="loading-overlay" id="loading"><div class="spinner" role="status" aria-label="è¼‰å…¥ä¸­"></div></div>

  <script>
    // ===== State =====
    let stockData = {}; let processedData = {}; let currentETF='00981A'; let currentMode='changes'; let currentStock=null; let detailETF=null; let trendChart=null;
    // ===== Utils =====
    const NF = new Intl.NumberFormat('zh-TW');
    const formatNumber = (num) => (num===null||num===undefined||isNaN(num))?'-':NF.format(Number(num));
    const el=(tag,props={},children=[])=>{const n=document.createElement(tag);Object.entries(props).forEach(([k,v])=>{if(k==='className')n.className=v;else if(k==='text')n.textContent=v??'';else if(k.startsWith('on')&&typeof v==='function')n.addEventListener(k.substring(2).toLowerCase(),v);else if(k==='dataset'&&v&&typeof v==='object')Object.entries(v).forEach(([dk,dv])=>n.dataset[dk]=dv);else if(v!==undefined&&v!==null)n.setAttribute(k,v);});(Array.isArray(children)?children:[children]).filter(Boolean).forEach(c=>n.appendChild(c));return n;}
    const debounce=(fn,wait=250)=>{let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),wait)}}
    const showLoading=(y)=>document.getElementById('loading').classList.toggle('active',!!y)

    // ===== Mode =====
    function switchMode(mode){currentMode=mode;document.querySelectorAll('.tab-btn').forEach(btn=>btn.classList.toggle('active',btn.dataset.mode===mode));const m={changes:document.getElementById('changesMode'),search:document.getElementById('searchMode'),ranks:document.getElementById('ranksMode'),strategy:document.getElementById('strategyMode')};Object.values(m).forEach(v=>v.classList.add('hidden'));m[mode].classList.remove('hidden');if(mode==='search')renderStockList(Object.values(stockData));if(mode==='ranks')renderRanks();if(mode==='strategy')renderStrategy();document.getElementById('detailPage').classList.remove('active');}
    function switchETF(code){currentETF=code;document.querySelectorAll('.etf-tab').forEach(tab=>{const group=tab.parentElement.id;if(group==='etfTabs'||group==='etfTabsRanks'||group==='etfTabsStrategy'){tab.classList.toggle('active',tab.dataset.etf===code);}});if(currentMode==='changes')renderChanges();if(currentMode==='ranks')renderRanks();if(currentMode==='strategy')renderStrategy();}

    // ===== Renderers =====
    function renderETFPriceInfo(data){const wrap=document.getElementById('etfPriceInfo');wrap.innerHTML='';if(!data)return;const changeValue=Number(data.change_value||0);const box=el('div',{className:'etf-price-box'},[el('div',{className:'etf-price-code',text:currentETF}),el('div',{className:'etf-price-name',text:data.name||''}),el('div',{className:'etf-price-value',text:`$${data.price??'-'}`},[]),el('div',{className:`etf-price-change ${isNaN(changeValue)?'':(changeValue<0?'negative':'positive')}`,text:`${!isNaN(changeValue)&&changeValue>=0?'ğŸ“ˆ â–²':'ğŸ“‰ â–¼'} ${data.change_value??''} ${data.change_percent??''}`})]);wrap.appendChild(box);}
    function renderSummaryBar(){const d=processedData[currentETF];const s=d?.summary;const bar=document.getElementById('summaryBar');bar.innerHTML='';if(!s)return;const netClass=s.net_count_change_thousand>=0?'positive':'negative';const netWClass=s.net_weight_change_pct>=0?'positive':'negative';[{t:'æœŸé–“',v:`${d.previous_date} â†’ ${d.latest_date}`},{t:'æ–°å¢å®¶æ•¸',v:s.new_count},{t:'åˆªé™¤å®¶æ•¸',v:s.closed_count},{t:'åŠ ç¢¼å®¶æ•¸',v:s.add_count},{t:'æ¸›ç¢¼å®¶æ•¸',v:s.reduce_count},{t:'æ·¨è®Šå‹•(å¼µ)',v:(s.net_count_change_thousand>=0?'+':'')+s.net_count_change_thousand,cls:netClass},{t:'æ·¨è®Šå‹•(æ¬Šé‡%)',v:(s.net_weight_change_pct>=0?'+':'')+s.net_weight_change_pct.toFixed(2)+'%',cls:netWClass},{t:'é‡å¤§å¢æŒå®¶æ•¸',v:s.major_add_count},{t:'é‡å¤§æ¸›æŒå®¶æ•¸',v:s.major_reduce_count}].forEach(it=>{bar.appendChild(el('div',{className:'summary-card'},[el('h4',{text:it.t}),el('div',{className:`summary-val ${it.cls||''}`,text:String(it.v)})]));});}
    function renderChanges(){const d=processedData[currentETF];renderETFPriceInfo(d);renderSummaryBar();const grid=document.getElementById('changesGrid');grid.innerHTML='';if(!d||!Array.isArray(d.daily_changes)||d.daily_changes.length===0){grid.appendChild(el('p',{className:'no-data',text:'ä»Šæ—¥ç„¡ç•°å‹•è³‡æ–™'}));return;}d.daily_changes.forEach(ch=>{const type=ch.type;const badgeClass=type==='æ–°å¢'?'new':type==='å¢æŒ'?'add':type==='æ¸›æŒ'?'reduce':'delete';const cardClass=type==='æ–°å¢'?'new-add':type==='åˆªé™¤'?'delete':'';const badgeIcon=type==='æ–°å¢'?'âœ¨':type==='åˆªé™¤'?'ğŸ—‘ï¸':type==='å¢æŒ'?'ğŸ“ˆ':'ğŸ“‰';const card=el('div',{className:`change-card ${cardClass}`,role:'button',tabindex:'0'});card.addEventListener('click',()=>showStockDetail(ch.code,currentETF));card.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' ')showStockDetail(ch.code,currentETF)});const header=el('div',{className:'change-card-header'},[el('div',{className:'change-code-name'},[el('div',{className:'change-code',text:ch.code||''}),el('div',{className:'change-name',text:ch.name||''})]),el('span',{className:`badge ${badgeClass}`},[el('span',{className:'badge-icon',text:badgeIcon}),document.createTextNode(type)])]);const stats=el('div',{className:'change-stats'},[el('div',{className:'stat-item'},[el('div',{className:'stat-label',text:'ğŸ’¼ ä»Šæ—¥æŒè‚¡'}),el('div',{className:'stat-value',text:formatNumber(ch.current_count)})]),el('div',{className:'stat-item'},[el('div',{className:'stat-label',text:'ğŸ’¯ ä»Šæ—¥æ¬Šé‡'}),el('div',{className:'stat-value',text:`${Number(ch.current_weight??0).toFixed(2)}%`})]),el('div',{className:'stat-item'},[el('div',{className:'stat-label',text:'ğŸ“Š å¼µæ•¸è®Šå‹•'}),el('div',{className:`stat-value ${ch.count_change>0?'positive':'negative'}`,text:`${ch.count_change>=0?'+':''}${formatNumber(ch.count_change)}`})]),el('div',{className:'stat-item'},[el('div',{className:'stat-label',text:'ğŸ“ˆ æ¬Šé‡è®Šå‹•'}),el('div',{className:`stat-value ${ch.weight_change>0?'positive':'negative'}`,text:`${ch.weight_change>=0?'+':''}${Number(ch.weight_change??0).toFixed(2)}%`})])]);card.append(header,stats);grid.appendChild(card);});}
    function renderStockList(stocks){const list=document.getElementById('stocksList');list.innerHTML='';if(!stocks||stocks.length===0){list.appendChild(el('p',{className:'no-data',text:'æš«ç„¡è‚¡ç¥¨æ•¸æ“š'}));return;}stocks.slice(0,200).forEach(s=>{const firstETF=Object.keys(s.etf_holdings||{})[0];const etfCount=Object.keys(s.etf_holdings||{}).length;const totalCount=Object.values(s.etf_holdings||{}).reduce((sum,e)=>sum+(e.current_count||0),0);const card=el('div',{className:'stock-card',role:'button',tabindex:'0'});card.addEventListener('click',()=>showStockDetail(s.code,firstETF));card.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' ')showStockDetail(s.code,firstETF)});const head=el('div',{className:'stock-card-header'},[el('div',{className:'stock-code',text:s.code||''}),el('div',{className:'stock-name',text:s.name||'(ç„¡åç¨±)'})]);const stats=el('div',{className:'stock-stats'},[el('div',{className:'stock-stat'},[el('div',{className:'stock-stat-label',text:'æŒæœ‰ETF'}),el('div',{className:'stock-stat-value',text:String(etfCount)})]),el('div',{className:'stock-stat'},[el('div',{className:'stock-stat-label',text:'ç¸½æŒè‚¡'}),el('div',{className:'stock-stat-value',text:formatNumber(totalCount)})])]);card.append(head,stats);list.appendChild(card);});}
    function ranksTable(title,rows,valueKey,suffix=''){const wrap=el('div',{className:'history-table',style:'margin-bottom:16px;'});const tbl=el('table');const thead=el('thead');thead.appendChild(el('tr',{},[el('th',{text:title}),el('th',{text:'ä»£ç¢¼'}),el('th',{text:'è®Šå‹•'})]));const tbody=el('tbody');(rows||[]).forEach(r=>{const tr=el('tr');tr.append(el('td',{text:r.name||''}),el('td',{text:r.code||''}),el('td',{text:(r[valueKey]>=0?'+':'')+(valueKey==='weight_change'?r[valueKey].toFixed(2):r[valueKey])+(suffix||'')}));tr.addEventListener('click',()=>showStockDetail(r.code,currentETF));tbody.appendChild(tr);});tbl.append(thead,tbody);wrap.appendChild(tbl);return wrap}
    function renderRanks(){const c=document.getElementById('ranksGrids');c.innerHTML='';const d=processedData[currentETF];if(!d?.ranks){c.appendChild(el('p',{className:'no-data',text:'æš«ç„¡æ’è¡Œè³‡æ–™'}));return;}const r=d.ranks;c.append(ranksTable('å¼µæ•¸å¢åŠ  Top',r.top_count_up,'count_change',' å¼µ'),ranksTable('å¼µæ•¸æ¸›å°‘ Top',r.top_count_down,'count_change',' å¼µ'),ranksTable('æ¬Šé‡å¢åŠ  Top',r.top_weight_up,'weight_change',' %'),ranksTable('æ¬Šé‡æ¸›å°‘ Top',r.top_weight_down,'weight_change',' %'),ranksTable('ä»Šæ—¥æ–°å¢',r.new_positions,'current_count',' å¼µ'),ranksTable('ä»Šæ—¥å‡ºæ¸…',r.closed_positions,'prev_count',' å¼µ'));}
    function gridFromStrategy(title,rows,countKey,extraCols=[]){const wrap=el('div',{className:'history-table',style:'margin-bottom:16px;'});const tbl=el('table');const thead=el('thead');const trh=el('tr');['åç¨±','ä»£ç¢¼','äº‹ä»¶æ¬¡æ•¸','ç•¶å‰å¼µæ•¸','æ·¨è®Šå‹•(å¼µ)'].concat(extraCols.map(c=>c.title)).forEach(h=>trh.appendChild(el('th',{text:h})));thead.appendChild(trh);const tbody=el('tbody');(rows||[]).forEach(r=>{const tr=el('tr');tr.append(el('td',{text:r.name||''}),el('td',{text:r.code||''}),el('td',{text:r.events||0}),el('td',{text:formatNumber(r.current_count||0)}),el('td',{text:(r[countKey]>=0?'+':'')+formatNumber(r[countKey])}));extraCols.forEach(c=>tr.appendChild(el('td',{text:r[c.key]||''})));tr.addEventListener('click',()=>showStockDetail(r.code,currentETF));tbody.appendChild(tr);});tbl.append(thead,tbody);wrap.appendChild(tbl);const cap=el('div',{className:'etf-price-name',text:title});return el('div',{},[cap,wrap])}
    function renderStrategy(){const d=processedData[currentETF];const box=document.getElementById('strategyHeader');const g=document.getElementById('strategyGrids');g.innerHTML='';box.innerHTML='';if(!d?.strategy){g.appendChild(el('p',{className:'no-data',text:'æš«ç„¡è¶¨å‹¢è³‡æ–™'}));return;}const p=d.strategy_params||{};box.append(el('div',{className:'etf-price-code',text:currentETF}),el('div',{className:'etf-price-name',text:`äº‹ä»¶çª—å£ï¼šæœ€è¿‘ ${p.trend_window||'-'} æ—¥ï¼›ä¸Šèª¿äº‹ä»¶â‰¥${p.min_increase_events||'-'} æ¬¡ï¼›ä¸‹èª¿äº‹ä»¶â‰¥${p.min_decrease_events||'-'} æ¬¡ï¼›åˆ¤å®šé–€æª»(æœ‰éƒ¨ä½)ï¼š>${(p.entry_threshold_shares||1000)/1000} å¼µ`}));const s=d.strategy;g.append(gridFromStrategy('ä¸Šèª¿äº‹ä»¶é”æ¨™',s.increasing,'net_increase'),gridFromStrategy('ä¸‹èª¿äº‹ä»¶é”æ¨™',s.decreasing,'net_decrease'),gridFromStrategy('æ–°å»ºç«‹éƒ¨ä½',s.new_positions||[],'current_count',[{title:'é€²å ´æ—¥',key:'entry_date'}]),gridFromStrategy('è¦–çª—å…§å‡ºæ¸…',s.closed_positions||[],'exit_count',[{title:'å‡ºæ¸…æ—¥',key:'exit_date'}]));}
    function showStockDetail(stockCode,etfCode){if(!stockData[stockCode])return;currentStock=stockCode;detailETF=etfCode;const s=stockData[stockCode];document.getElementById('changesMode').classList.add('hidden');document.getElementById('searchMode').classList.add('hidden');document.getElementById('ranksMode').classList.add('hidden');document.getElementById('strategyMode').classList.add('hidden');document.getElementById('detailPage').classList.add('active');document.getElementById('detailTitle').textContent=`ğŸ“ ${s.code} ${s.name||''}`;const etfCount=Object.keys(s.etf_holdings).length;const totalCount=Object.values(s.etf_holdings).reduce((sum,e)=>sum+(e.current_count||0),0);const maxCount=Math.max(0,...Object.values(s.etf_holdings).map(e=>e.max_count||0));const finiteMins=Object.values(s.etf_holdings).map(e=>e.min_count).filter(v=>Number.isFinite(v));const minCount=finiteMins.length?Math.min(...finiteMins):0;const stats=document.getElementById('statsContainer');stats.innerHTML='';stats.append(el('div',{className:'stat-box'},[el('div',{className:'stat-box-value',text:String(etfCount)}),el('div',{className:'stat-box-label',text:'æŒæœ‰ETF'})]),el('div',{className:'stat-box'},[el('div',{className:'stat-box-value',text:formatNumber(totalCount)}),el('div',{className:'stat-box-label',text:'ç•¶å‰ç¸½æŒè‚¡'})]),el('div',{className:'stat-box'},[el('div',{className:'stat-box-value',text:formatNumber(maxCount)}),el('div',{className:'stat-box-label',text:'æœ€é«˜æŒè‚¡'})]),el('div',{className:'stat-box'},[el('div',{className:'stat-box-value',text:formatNumber(minCount)}),el('div',{className:'stat-box-label',text:'æœ€ä½æŒè‚¡'})]));const tabsDetail=document.getElementById('etfTabsDetail');tabsDetail.innerHTML='';Object.entries(s.etf_holdings).forEach(([code,ed])=>{const btn=el('button',{className:'etf-tab'+(detailETF===code?' active':''),dataset:{etf:code}},[document.createTextNode(`${code} ${ed.etf_name}`)]);btn.addEventListener('click',()=>switchDetailETF(code));tabsDetail.appendChild(btn);});renderHistoryTable(etfCode);}
    function switchDetailETF(etfCode){detailETF=etfCode;document.querySelectorAll('#etfTabsDetail .etf-tab').forEach(t=>t.classList.toggle('active',t.dataset.etf===etfCode));renderHistoryTable(etfCode)}
    function renderHistoryTable(etfCode){const s=stockData[currentStock];const ed=s?.etf_holdings?.[etfCode];const body=document.getElementById('historyBody');if(!ed||!Array.isArray(ed.history)||ed.history.length===0){body.innerHTML='';body.appendChild(el('tr',{},[el('td',{colspan:'6',className:'no-data',text:'æš«ç„¡æ­·å²æ•¸æ“š'})]));document.getElementById('chartContainer').style.display='none';return;}const hist=[...ed.history].sort((a,b)=>new Date(b.date.replace(/\//g,'-'))-new Date(a.date.replace(/\//g,'-')));drawTrendChart(hist);body.innerHTML='';hist.forEach(r=>{const changeClass=r.count_change>0?'positive':r.count_change<0?'negative':'';const rowClass=r.status==='å‡ºæ¸…'?'row-delete':r.status==='é¦–æ¬¡å‡ºç¾'?'row-highlight':'';const countStr=r.count_change>=0?'+':'';const weightStr=r.weight_change>=0?'+':'';const statusKey=r.status==='å‡ºæ¸…'?'delete':r.status==='é¦–æ¬¡å‡ºç¾'?'new':r.status==='å¢æŒ'?'add':'reduce';const tr=el('tr',{className:rowClass});tr.append(el('td',{text:r.date}),el('td',{},[el('strong',{text:formatNumber(r.count)})]),el('td',{text:`${Number(r.weight??0).toFixed(2)}%`}),el('td',{className:changeClass},[el('strong',{text:`${countStr}${formatNumber(r.count_change)}`})]),el('td',{className:changeClass},[el('strong',{text:`${weightStr}${Number(r.weight_change??0).toFixed(2)}%`})]),el('td',{},[el('span',{className:`status-badge status-${statusKey}`,text:r.status})]));body.appendChild(tr);});}
    function drawTrendChart(history){const chartContainer=document.getElementById('chartContainer');chartContainer.style.display='block';const sorted=[...history].sort((a,b)=>new Date(a.date.replace(/\//g,'-'))-new Date(b.date.replace(/\//g,'-')));const labels=sorted.map(h=>h.date);const counts=sorted.map(h=>h.count);const ctx=document.getElementById('trendChart').getContext('2d');if(trendChart){trendChart.destroy();}trendChart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'æŒè‚¡å¼µæ•¸',data:counts,borderColor:'#667eea',backgroundColor:'rgba(102,126,234,0.1)',borderWidth:3,fill:true,tension:0.35,pointBackgroundColor:'#667eea',pointBorderColor:'#fff',pointBorderWidth:2,pointRadius:3,pointHoverRadius:5}]},options:{responsive:true,maintainAspectRatio:true,plugins:{legend:{display:false},decimation:{enabled:true,algorithm:'lttb'}},scales:{y:{beginAtZero:false,grid:{color:'rgba(0,0,0,0.05)'}}}}});}
    function backToMode(){document.getElementById('detailPage').classList.remove('active');if(currentMode==='changes'){document.getElementById('changesMode').classList.remove('hidden');}else if(currentMode==='search'){document.getElementById('searchMode').classList.remove('hidden');}else if(currentMode==='ranks'){document.getElementById('ranksMode').classList.remove('hidden');}else{document.getElementById('strategyMode').classList.remove('hidden');}currentStock=null;detailETF=null;}

    // ===== Fetch with fallbacks =====
    async function fetchJSONWithFallback(basenames){const tries=[];const ver=`?v=${Date.now()}`;for(const {urls} of basenames){for(const u of urls){const url=u+ver;try{const res=await fetch(url,{cache:'no-cache'});if(!res.ok)throw new Error(`HTTP ${res.status} ${res.statusText}`);const txt=await res.text();return JSON.parse(txt);}catch(e){tries.push(`[${url}] ${e.message}`);}}}throw new Error(tries.join('\n'));}

    async function loadData(){showLoading(true);try{const owner='yoyo3316';const repo='yoyo3316.github.io';const branch='main';const pdata=await fetchJSONWithFallback([{urls:['./processed_etf_data.json','https://yoyo3316.github.io/processed_etf_data.json',`https://raw.githubusercontent.com/${owner}/${repo}/${branch}/processed_etf_data.json`]}]);let sdata;try{sdata=await fetchJSONWithFallback([{urls:['./stock_history_data.json','https://yoyo3316.github.io/stock_history_data.json',`https://raw.githubusercontent.com/${owner}/${repo}/${branch}/stock_history_data.json`]}]);}catch(e){throw e;}processedData=pdata;stockData=sdata;const firstKey=Object.keys(processedData)[0];if(firstKey&&processedData[firstKey]?.latest_date){document.getElementById('updateTime').textContent='æœ€æ–°æ›´æ–°: '+processedData[firstKey].latest_date;}renderChanges();document.getElementById('searchInput')?.addEventListener('input',debounce((e)=>{const kw=(e.target.value||'').toLowerCase().trim();if(!kw){renderStockList(Object.values(stockData));return;}const filtered=Object.values(stockData).filter(st=>st.code.includes(kw)||(st.name||'').toLowerCase().includes(kw));renderStockList(filtered);},200));}catch(err){console.error(err);alert(`è¼‰å…¥å¤±æ•—ï¼š\n${err.message}\nè«‹ç¢ºèªæª”æ¡ˆåœ¨æ ¹ç›®éŒ„ä¸”ç‚ºæœ‰æ•ˆ JSONï¼ˆå»ºè­°æ ¹ç›®éŒ„æ–°å¢ .nojekyllï¼‰ã€‚`);}finally{showLoading(false);}}

    // ===== Bindings =====
    document.addEventListener('click',e=>{const t=e.target.closest('.tab-btn');if(t){switchMode(t.dataset.mode);}const etfTab=e.target.closest('.etf-tab');if(etfTab&&etfTab.dataset.etf){switchETF(etfTab.dataset.etf);}});
    document.getElementById('backBtn').addEventListener('click',backToMode);
    document.addEventListener('DOMContentLoaded',loadData);
  </script>
</body>
</html>
